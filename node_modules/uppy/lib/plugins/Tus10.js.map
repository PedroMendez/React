{"version":3,"sources":["../../src/plugins/Tus10.js"],"names":["Plugin","require","tus","UppySocket","Utils","tusDefaultOptions","endpoint","resume","onProgress","onChunkComplete","onSuccess","onError","headers","chunkSize","Infinity","withCredentials","uploadUrl","uploadSize","overridePatchMethod","retryDelays","module","exports","core","opts","type","id","title","defaultOptions","allowPause","autoRetry","handlePauseAll","bind","handleResumeAll","handleResetProgress","handleUpload","pauseResume","action","fileID","updatedFiles","getState","files","inProgressUpdatedFiles","Object","keys","filter","file","progress","uploadComplete","uploadStarted","wasPaused","isPaused","updatedFile","setState","forEach","state","tusState","upload","current","total","log","resolve","reject","optsTus","err","emit","bytesUploaded","bytesTotal","onReceiveUploadUrl","url","uploader","name","metadata","meta","Upload","data","onFileRemove","targetFileID","abort","onPause","start","onPauseAll","onResumeAll","on","uploadRemote","remote","serverToken","connectToServerSocket","emitter","fetch","method","credentials","body","JSON","stringify","protocol","size","then","res","status","statusText","json","token","getFile","updateFile","host","getSocketHost","socket","target","send","progressData","emitSocketProgress","close","uploadURL","currentFile","newFile","cb","uploadFiles","index","parseInt","length","isRemote","fileIDs","Promise","filesToUpload","map","once","actions","addResumableUploadsCapabilityFlag","newCapabilities","capabilities","resumableUploads","install","addUploader","uninstall","removeUploader","off"],"mappings":"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","file":"Tus10.js","sourcesContent":["const Plugin = require('./Plugin')\nconst tus = require('tus-js-client')\nconst UppySocket = require('../core/UppySocket')\nconst Utils = require('../core/Utils')\nrequire('whatwg-fetch')\n\n// Extracted from https://github.com/tus/tus-js-client/blob/master/lib/upload.js#L13\n// excepted we removed 'fingerprint' key to avoid adding more dependencies\nconst tusDefaultOptions = {\n  endpoint: '',\n  resume: true,\n  onProgress: null,\n  onChunkComplete: null,\n  onSuccess: null,\n  onError: null,\n  headers: {},\n  chunkSize: Infinity,\n  withCredentials: false,\n  uploadUrl: null,\n  uploadSize: null,\n  overridePatchMethod: false,\n  retryDelays: null\n}\n\n/**\n * Tus resumable file uploader\n *\n */\nmodule.exports = class Tus10 extends Plugin {\n  constructor (core, opts) {\n    super(core, opts)\n    this.type = 'uploader'\n    this.id = 'Tus'\n    this.title = 'Tus'\n\n    // set default options\n    const defaultOptions = {\n      resume: true,\n      allowPause: true,\n      autoRetry: true,\n      retryDelays: [0, 1000, 3000, 5000]\n    }\n\n    // merge default options with the ones set by user\n    this.opts = Object.assign({}, defaultOptions, opts)\n\n    this.handlePauseAll = this.handlePauseAll.bind(this)\n    this.handleResumeAll = this.handleResumeAll.bind(this)\n    this.handleResetProgress = this.handleResetProgress.bind(this)\n    this.handleUpload = this.handleUpload.bind(this)\n  }\n\n  pauseResume (action, fileID) {\n    const updatedFiles = Object.assign({}, this.core.getState().files)\n    const inProgressUpdatedFiles = Object.keys(updatedFiles).filter((file) => {\n      return !updatedFiles[file].progress.uploadComplete &&\n             updatedFiles[file].progress.uploadStarted\n    })\n\n    switch (action) {\n      case 'toggle':\n        if (updatedFiles[fileID].uploadComplete) return\n\n        const wasPaused = updatedFiles[fileID].isPaused || false\n        const isPaused = !wasPaused\n        let updatedFile\n        if (wasPaused) {\n          updatedFile = Object.assign({}, updatedFiles[fileID], {\n            isPaused: false\n          })\n        } else {\n          updatedFile = Object.assign({}, updatedFiles[fileID], {\n            isPaused: true\n          })\n        }\n        updatedFiles[fileID] = updatedFile\n        this.core.setState({files: updatedFiles})\n        return isPaused\n      case 'pauseAll':\n        inProgressUpdatedFiles.forEach((file) => {\n          const updatedFile = Object.assign({}, updatedFiles[file], {\n            isPaused: true\n          })\n          updatedFiles[file] = updatedFile\n        })\n        this.core.setState({files: updatedFiles})\n        return\n      case 'resumeAll':\n        inProgressUpdatedFiles.forEach((file) => {\n          const updatedFile = Object.assign({}, updatedFiles[file], {\n            isPaused: false\n          })\n          updatedFiles[file] = updatedFile\n        })\n        this.core.setState({files: updatedFiles})\n        return\n    }\n  }\n\n  handlePauseAll () {\n    this.pauseResume('pauseAll')\n  }\n\n  handleResumeAll () {\n    this.pauseResume('resumeAll')\n  }\n\n  handleResetProgress () {\n    const files = Object.assign({}, this.core.state.files)\n    Object.keys(files).forEach((fileID) => {\n      // Only clone the file object if it has a Tus `uploadUrl` attached.\n      if (files[fileID].tus && files[fileID].tus.uploadUrl) {\n        const tusState = Object.assign({}, files[fileID].tus)\n        delete tusState.uploadUrl\n        files[fileID] = Object.assign({}, files[fileID], { tus: tusState })\n      }\n    })\n\n    this.core.setState({ files })\n  }\n\n  /**\n   * Create a new Tus upload\n   *\n   * @param {object} file for use with upload\n   * @param {integer} current file in a queue\n   * @param {integer} total number of files in a queue\n   * @returns {Promise}\n   */\n  upload (file, current, total) {\n    this.core.log(`uploading ${current} of ${total}`)\n\n    // Create a new tus upload\n    return new Promise((resolve, reject) => {\n      const optsTus = Object.assign(\n        {},\n        tusDefaultOptions,\n        this.opts,\n        // Install file-specific upload overrides.\n        file.tus || {}\n      )\n\n      optsTus.onError = (err) => {\n        this.core.log(err)\n        this.core.emit('core:upload-error', file.id, err)\n        reject('Failed because: ' + err)\n      }\n\n      optsTus.onProgress = (bytesUploaded, bytesTotal) => {\n        this.onReceiveUploadUrl(file, upload.url)\n        this.core.emit('core:upload-progress', {\n          uploader: this,\n          id: file.id,\n          bytesUploaded: bytesUploaded,\n          bytesTotal: bytesTotal\n        })\n      }\n\n      optsTus.onSuccess = () => {\n        this.core.emit('core:upload-success', file.id, upload, upload.url)\n\n        if (upload.url) {\n          this.core.log('Download ' + upload.file.name + ' from ' + upload.url)\n        }\n\n        resolve(upload)\n      }\n      optsTus.metadata = file.meta\n\n      const upload = new tus.Upload(file.data, optsTus)\n\n      this.onFileRemove(file.id, (targetFileID) => {\n        // this.core.log(`removing file: ${targetFileID}`)\n        upload.abort()\n        resolve(`upload ${targetFileID} was removed`)\n      })\n\n      this.onPause(file.id, (isPaused) => {\n        isPaused ? upload.abort() : upload.start()\n      })\n\n      this.onPauseAll(file.id, () => {\n        upload.abort()\n      })\n\n      this.onResumeAll(file.id, () => {\n        upload.start()\n      })\n\n      this.core.on('core:retry-started', () => {\n        const files = this.core.getState().files\n        if (files[file.id].progress.uploadComplete ||\n          !files[file.id].progress.uploadStarted ||\n          files[file.id].isPaused\n            ) {\n          return\n        }\n        upload.start()\n      })\n\n      upload.start()\n      this.core.emit('core:upload-started', file.id, upload)\n    })\n  }\n\n  uploadRemote (file, current, total) {\n    return new Promise((resolve, reject) => {\n      this.core.log(file.remote.url)\n      if (file.serverToken) {\n        this.connectToServerSocket(file)\n      } else {\n        let endpoint = this.opts.endpoint\n        if (file.tus && file.tus.endpoint) {\n          endpoint = file.tus.endpoint\n        }\n\n        this.core.emitter.emit('core:upload-started', file.id)\n\n        fetch(file.remote.url, {\n          method: 'post',\n          credentials: 'include',\n          headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify(Object.assign({}, file.remote.body, {\n            endpoint,\n            protocol: 'tus',\n            size: file.data.size,\n            metadata: file.meta\n          }))\n        })\n        .then((res) => {\n          if (res.status < 200 && res.status > 300) {\n            return reject(res.statusText)\n          }\n\n          res.json().then((data) => {\n            const token = data.token\n            file = this.getFile(file.id)\n            file.serverToken = token\n            this.updateFile(file)\n            this.connectToServerSocket(file)\n            resolve()\n          })\n        })\n      }\n    })\n  }\n\n  connectToServerSocket (file) {\n    const token = file.serverToken\n    const host = Utils.getSocketHost(file.remote.host)\n    const socket = new UppySocket({ target: `${host}/api/${token}` })\n\n    this.onFileRemove(file.id, () => socket.send('pause', {}))\n\n    this.onPause(file.id, (isPaused) => {\n      isPaused ? socket.send('pause', {}) : socket.send('resume', {})\n    })\n\n    this.onPauseAll(file.id, () => socket.send('pause', {}))\n    this.onResumeAll(file.id, () => socket.send('resume', {}))\n\n    socket.on('progress', (progressData) => Utils.emitSocketProgress(this, progressData, file))\n\n    socket.on('success', (data) => {\n      this.core.emitter.emit('core:upload-success', file.id, data, data.url)\n      socket.close()\n    })\n  }\n\n  getFile (fileID) {\n    return this.core.state.files[fileID]\n  }\n\n  updateFile (file) {\n    const files = Object.assign({}, this.core.state.files, {\n      [file.id]: file\n    })\n    this.core.setState({ files })\n  }\n\n  onReceiveUploadUrl (file, uploadURL) {\n    const currentFile = this.getFile(file.id)\n    if (!currentFile) return\n    // Only do the update if we didn't have an upload URL yet.\n    if (!currentFile.tus || currentFile.tus.uploadUrl !== uploadURL) {\n      const newFile = Object.assign({}, currentFile, {\n        tus: Object.assign({}, currentFile.tus, {\n          uploadUrl: uploadURL\n        })\n      })\n      this.updateFile(newFile)\n    }\n  }\n\n  onFileRemove (fileID, cb) {\n    this.core.on('core:file-removed', (targetFileID) => {\n      if (fileID === targetFileID) cb(targetFileID)\n    })\n  }\n\n  onPause (fileID, cb) {\n    this.core.on('core:upload-pause', (targetFileID) => {\n      if (fileID === targetFileID) {\n        const isPaused = this.pauseResume('toggle', fileID)\n        cb(isPaused)\n      }\n    })\n  }\n\n  onPauseAll (fileID, cb) {\n    this.core.on('core:pause-all', () => {\n      if (!this.core.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onResumeAll (fileID, cb) {\n    this.core.on('core:resume-all', () => {\n      if (!this.core.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  uploadFiles (files) {\n    files.forEach((file, index) => {\n      const current = parseInt(index, 10) + 1\n      const total = files.length\n\n      if (!file.isRemote) {\n        this.upload(file, current, total)\n      } else {\n        this.uploadRemote(file, current, total)\n      }\n    })\n  }\n\n  handleUpload (fileIDs) {\n    if (fileIDs.length === 0) {\n      this.core.log('Tus: no files to upload!')\n      return Promise.resolve()\n    }\n\n    this.core.log('Tus is uploading...')\n    const filesToUpload = fileIDs.map((fileID) => this.core.getFile(fileID))\n\n    this.uploadFiles(filesToUpload)\n\n    return new Promise((resolve) => {\n      this.core.once('core:upload-complete', resolve)\n    })\n  }\n\n  actions () {\n    this.core.on('core:pause-all', this.handlePauseAll)\n    this.core.on('core:resume-all', this.handleResumeAll)\n    this.core.on('core:reset-progress', this.handleResetProgress)\n\n    if (this.opts.autoRetry) {\n      this.core.on('back-online', () => {\n        this.core.emit('core:retry-started')\n      })\n    }\n  }\n\n  addResumableUploadsCapabilityFlag () {\n    const newCapabilities = Object.assign({}, this.core.getState().capabilities)\n    newCapabilities.resumableUploads = true\n    this.core.setState({\n      capabilities: newCapabilities\n    })\n  }\n\n  install () {\n    this.addResumableUploadsCapabilityFlag()\n    this.core.addUploader(this.handleUpload)\n    this.actions()\n  }\n\n  uninstall () {\n    this.core.removeUploader(this.handleUpload)\n    this.core.off('core:pause-all', this.handlePauseAll)\n    this.core.off('core:resume-all', this.handleResumeAll)\n  }\n}\n"]}